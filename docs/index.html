<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x402Resolve - Live Demo | Solana x402 Hackathon 2025</title>
    <link rel="icon" type="image/x-icon" href="./media/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
    <script src="./oracle-transactions.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Atkinson Hyperlegible', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: #e5e5e5;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            cursor: none;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border: 1px solid #ff44f5;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 40px;
            padding: 20px;
            border-bottom: 1px solid #222;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 20px;
        }

        .header-left {
            flex: 0 0 auto;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .header-right {
            flex: 0 0 auto;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #fff;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1rem;
            color: #888;
        }

        .live-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: transparent;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 0.875rem;
            flex: 1;
            min-height: 48px;
            max-width: 250px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .network-status {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
            max-width: 1050px;
            margin-left: auto;
            margin-right: auto;
        }

        .status-item {
            background: transparent;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 0.875rem;
            color: #888;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-height: 48px;
            max-width: 250px;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            background: transparent;
            border-bottom: 1px solid #222;
            padding: 0;
        }

        .tab {
            background: transparent;
            color: #888;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 12px 24px;
            font-size: 0.9375rem;
            cursor: pointer;
            font-weight: 500;
            border-radius: 0;
            transition: all 0.2s;
            flex: 1;
            white-space: nowrap;
            margin-bottom: -1px;
            position: relative;
            text-transform: uppercase;
        }

        .tab:hover {
            background: transparent;
            color: #fff;
        }

        .tab:hover::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #00d9ff, #ff00ff);
            opacity: 0.6;
        }

        .tab.active {
            background: transparent;
            color: #fff;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #00d9ff, #ff00ff);
        }

        .tab-content {
            padding-top: 32px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }

            .header-top {
                flex-direction: column;
                text-align: center;
            }

            .header-left img {
                width: 180px !important;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                padding: 16px;
            }
        }

        .card {
            background: #000;
            border: 1px solid #222;
            border-radius: 8px;
            padding: 24px;
        }

        .card h2 {
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .card h2 span {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #e5e5e5;
            font-weight: 400;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 0.9375rem;
            background: #0a0a0a;
            color: #e5e5e5;
            transition: border-color 0.2s;
            font-family: 'Atkinson Hyperlegible', monospace;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #555;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: #ff00ff;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            text-transform: none !important;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-magenta-outline {
            background: #ff00ff !important;
            color: #fff !important;
            border: none !important;
            width: auto !important;
            padding: 12px 32px !important;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            transition: all 0.2s ease;
            cursor: pointer;
            border-radius: 6px;
            text-transform: none !important;
        }

        .btn-magenta-outline:hover:not(:disabled) {
            background: #ff44f5 !important;
        }

        .btn-magenta-outline:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        a {
            color: #ff00ff;
            transition: color 0.2s;
        }

        a:hover {
            color: #e600e6;
        }

        .oracle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .oracle-card {
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .oracle-status {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .oracle-score {
            font-size: 2.5rem;
            font-weight: 300;
            margin: 10px 0;
            background: linear-gradient(90deg, #4fe9ea, #ff44f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        .oracle-reputation {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .consensus-viz {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .consensus-result {
            text-align: center;
            padding: 30px;
            border: 1px solid #222;
            border-radius: 8px;
            margin-top: 20px;
        }

        .consensus-score {
            font-size: 4rem;
            font-weight: 300;
            margin: 10px 0;
            background: linear-gradient(90deg, #4fe9ea, #ff44f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            opacity: 0.3;
            transition: opacity 0.3s;
        }

        .timeline-item.active {
            opacity: 1;
        }

        .timeline-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
            flex-shrink: 0;
            margin-top: 3px;
        }

        .timeline-item.active .timeline-dot {
            background: #00d9ff;
            box-shadow: 0 0 0 4px rgba(0, 217, 255, 0.2);
        }

        .gradient-text {
            background: linear-gradient(90deg, #4fe9ea, #ff44f5);
            background-size: 200% 100%;
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
        }

        /* ========================================
           DEMO EFFECTS - Click Ripple
           Comment out this section to disable
           ======================================== */
        .click-ripple {
            position: fixed;
            border-radius: 50%;
            border: 1px solid;
            pointer-events: none;
            z-index: 9999;
        }

        .click-ripple.magenta {
            animation: ripple-expand-magenta 2.5s ease-out forwards;
        }

        .click-ripple.black {
            animation: ripple-expand-black 2.5s ease-out forwards;
        }

        @keyframes ripple-expand-magenta {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
                border-color: #ff44f5;
            }
            100% {
                width: 125px;
                height: 125px;
                opacity: 0;
                border-color: #ff44f5;
            }
        }

        @keyframes ripple-expand-black {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
                border-color: #000000;
            }
            100% {
                width: 125px;
                height: 125px;
                opacity: 0;
                border-color: #000000;
            }
        }
        /* ======================================== */

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid;
            font-size: 0.875rem;
        }

        .alert-info {
            background: rgba(0, 217, 255, 0.1);
            border-color: rgba(0, 217, 255, 0.3);
            color: #00d9ff;
        }

        .alert-success {
            background: rgba(0, 217, 255, 0.1);
            border-color: rgba(0, 217, 255, 0.3);
            color: #00d9ff;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 8px 0;
            color: #fff;
        }

        .stat-label {
            font-size: 0.8125rem;
            color: #888;
        }

        .code-block {
            background: #0a0a0a;
            color: #e5e5e5;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 15px 0;
            position: relative;
        }

        .code-block pre {
            margin: 0;
        }

        .code-keyword {
            color: #ff44f5;
        }

        .code-function {
            color: #4fe9ea;
        }

        .code-string {
            color: #00d9ff;
        }

        .code-comment {
            color: #666;
            font-style: italic;
        }

        .copy-button {
            float: right;
            background: #475569;
            padding: 5px 15px;
            font-size: 0.85rem;
            border-radius: 5px;
            width: auto;
        }

        .metric-badge {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 5px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .wallet-connect-btn {
            background: #AB9FF2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 48px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: auto;
        }

        .wallet-connect-btn img {
            width: 24px;
            height: 24px;
        }

        .wallet-connect-btn:hover {
            background: #9B8FE2;
            transform: scale(1.02);
        }

        .wallet-connect-btn:disabled {
            background: #333;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-connected {
            background: #10b981;
        }

        .wallet-connected:hover {
            background: #059669;
        }

        .wallet-info {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            margin-left: 10px;
            font-size: 0.85rem;
        }

        .explorer-link {
            display: inline-block;
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 10px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .explorer-link:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="header-left">
                    <a href="https://x402kamiyo.github.io/x402resolve/">
                        <img src="./media/kamiyo_logomark.png" alt="KAMIYO" style="width: 200px; height: auto;">
                    </a>
                </div>
                <div class="header-center">
                    <h1 style="margin: 0 0 10px 0; font-weight: 600;">x402Resolve</h1>
                    <p style="margin: 0;">Quality-verified HTTP 402 payments with sliding-scale refunds on Solana</p>
                </div>
                <div class="header-right">
                    <button id="walletBtn" class="wallet-connect-btn" onclick="connectWallet()">
                        <img src="./media/Phantom-Icon_Transparent_White.svg" alt="Phantom">
                        Connect Wallet
                    </button>
                </div>
            </div>
            <div class="network-status">
                <div class="live-badge">
                    <span class="live-dot"></span>
                    <span>Live on Devnet</span>
                </div>
                <span class="status-item" id="programStatus">Program: Loading...</span>
                <span class="status-item" id="oracleStatus">Oracle: Checking...</span>
                <span class="status-item" id="networkStatus">Network: Connecting...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('live')">Live Dispute Resolution</button>
            <button class="tab" onclick="switchTab('multi-oracle')">Multi-Oracle Simulator</button>
            <button class="tab" onclick="switchTab('analytics')">Live Analytics</button>
            <button class="tab" onclick="switchTab('integration')">SDK Integration</button>
        </div>

        <!-- Tab 1: Live Dispute Resolution -->
        <div id="live-tab" class="tab-content active">
            <div class="demo-grid">
                <div class="card">
                    <h2><span>‚ö°</span> File Dispute</h2>
                    <div class="alert alert-info">
                        <strong>Live Mode:</strong> Connected to Solana Devnet. Real transactions submitted on-chain.
                    </div>

                    <form id="disputeForm">
                        <div class="form-group">
                            <label>Transaction ID</label>
                            <input type="text" id="transactionId" value="" placeholder="Auto-generated">
                        </div>

                        <div class="form-group">
                            <label>Query (What you expected)</label>
                            <textarea id="originalQuery" placeholder="e.g., Uniswap V3 exploits on Ethereum with transaction hashes">Uniswap V3 exploits on Ethereum</textarea>
                        </div>

                        <div class="form-group">
                            <label>Data Quality Issue</label>
                            <select id="disputeReason">
                                <option value="incomplete">Missing required fields (tx_hash, amount)</option>
                                <option value="wrong_protocol">Wrong protocol (got Curve, expected Uniswap)</option>
                                <option value="wrong_chain">Wrong blockchain (got BSC, expected Ethereum)</option>
                                <option value="outdated">Outdated data (>90 days old)</option>
                                <option value="inaccurate">Factually inaccurate information</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Escrow Amount (SOL)</label>
                            <input type="number" id="escrowAmount" value="0.01" step="0.001" min="0.001" max="10">
                        </div>

                        <button type="submit" id="submitBtn" class="btn-magenta-outline">Submit to Solana devnet</button>
                    </form>
                </div>

                <div class="card">
                    <h2><span>üî¨</span> Quality Verification</h2>

                    <div id="statusDisplay" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 500px; padding: 60px 20px 40px 20px;">
                        <video id="demoVideo" autoplay loop muted playsinline style="width: 50%; max-width: 50%; border-radius: 8px; display: block; margin-bottom: 20px;">
                            <source src="./media/pfn_x_42.mp4" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div class="alert alert-info" style="margin-bottom: 0; text-align: center;">
                            Submit a dispute to see real-time quality scoring
                        </div>
                    </div>

                    <div id="timelineDisplay" style="display: none;">
                        <div class="timeline">
                            <div class="timeline-item" id="step1">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <h4>Dispute Filed on Solana</h4>
                                    <p id="step1-detail">Transaction submitted...</p>
                                </div>
                            </div>
                            <div class="timeline-item" id="step2">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <h4>Verifier Oracle Analysis</h4>
                                    <p>AI quality scoring (semantic + completeness + freshness)</p>
                                </div>
                            </div>
                            <div class="timeline-item" id="step3">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <h4>Ed25519 Signature Generated</h4>
                                    <p>Cryptographic proof of quality score</p>
                                </div>
                            </div>
                            <div class="timeline-item" id="step4">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <h4>Refund Processed</h4>
                                    <p>Smart contract executes sliding-scale refund</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="resultsDisplay" style="display: none;"></div>
                </div>
            </div>

            <div class="card">
                <h2><span>üí∞</span> Cost Comparison</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px;">
                    <div style="text-align: center; padding: 40px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #222;">
                        <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;">Traditional Processors</div>
                        <div style="font-size: 2.5rem; color: #888; font-weight: 300; margin: 20px 0;">$35</div>
                        <div style="color: #666; font-size: 0.875rem; margin-bottom: 10px;">Per Dispute</div>
                        <div style="font-size: 2rem; color: #888; font-weight: 300; margin: 20px 0;">90 days</div>
                        <div style="color: #666; font-size: 0.875rem;">Resolution Time</div>
                    </div>
                    <div style="text-align: center; padding: 40px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #333;">
                        <div style="font-size: 0.75rem; color: #00d9ff; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;">x402Resolve</div>
                        <div class="gradient-text" style="font-size: 2.5rem; font-weight: 300; margin: 20px 0;">$0.005</div>
                        <div style="color: #888; font-size: 0.875rem; margin-bottom: 10px;">Per Dispute</div>
                        <div class="gradient-text" style="font-size: 2rem; font-weight: 300; margin: 20px 0;">48 hours</div>
                        <div style="color: #888; font-size: 0.875rem;">Resolution Time</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px; padding: 15px; border-top: 1px solid #222;">
                    <div style="font-size: 1rem; color: #ccc; margin-bottom: 5px;">99.98% cost reduction ‚Ä¢ 98% faster</div>
                    <div style="color: #666; font-size: 0.75rem;">Powered by Solana blockchain</div>
                </div>
            </div>

            <div class="card">
                <h2><span>üéØ</span> Key Performance Data</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                    <div style="text-align: center; padding: 30px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #222;">
                        <div style="color: #888; font-size: 0.875rem; margin-bottom: 10px;">Fraud Reduction</div>
                        <div class="gradient-text" style="font-size: 2.5rem; font-weight: 300;">81%</div>
                    </div>
                    <div style="text-align: center; padding: 30px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #222;">
                        <div style="color: #888; font-size: 0.875rem; margin-bottom: 10px;">Oracle Success</div>
                        <div class="gradient-text" style="font-size: 2.5rem; font-weight: 300;">99.9%</div>
                    </div>
                    <div style="text-align: center; padding: 30px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #222;">
                        <div style="color: #888; font-size: 0.875rem; margin-bottom: 10px;">Response Time</div>
                        <div class="gradient-text" style="font-size: 2.5rem; font-weight: 300;">1.8s</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Multi-Oracle Simulator -->
        <div id="multi-oracle-tab" class="tab-content">
            <div class="card">
                <h2><span>ü§ñ</span> Multi-Oracle Quality Verification</h2>
                <div class="alert alert-info">
                    Real-time quality scoring using Ed25519-signed oracle assessments. Production system supports Switchboard On-Demand oracles for decentralized verification.
                </div>

                <div style="background: #0a0a0a; border: 1px solid #222; border-radius: 8px; padding: 20px; margin: 20px 0;">
                    <h3 style="color: #fff; margin-bottom: 15px; font-size: 1rem;">Recent On-Chain Oracle Assessments</h3>
                    <div id="recentAssessments" style="font-family: monospace; font-size: 0.85rem; color: #888;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Loading recent Switchboard oracle transactions...
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #222;">
                        <a href="https://explorer.solana.com/address/D9adezZ12cosX3GG2jK6PpbwMFLHzcCYVpcPCFcaciYP?cluster=devnet" target="_blank" style="color: #00d9ff; text-decoration: none; font-size: 0.875rem;">
                            View All Program Transactions ‚Üí
                        </a>
                    </div>
                </div>

                <div class="form-group">
                    <label>Transaction Value (SOL)</label>
                    <input type="number" id="oracleValue" value="0.1" step="0.01" min="0.01" max="10">
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        Transactions > 1 SOL require 3-oracle consensus
                    </p>
                </div>

                <button onclick="runMultiOracle()" id="oracleBtn" class="btn-magenta-outline">Run on-chain quality assessment</button>
                <div id="oracleProgress" style="width: 100%; height: 2px; background: #1a1a1a; margin-top: 10px; border-radius: 1px; overflow: hidden; display: none; position: relative;">
                    <div id="oracleProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ff44f5, #00d9ff, #ff44f5); background-size: 200% 100%; animation: gradientFlow 2s linear infinite; transition: width 0.3s ease; position: relative;">
                        <div style="position: absolute; inset: 0; background: repeating-linear-gradient(90deg, transparent, transparent 8px, rgba(0,0,0,0.3) 8px, rgba(0,0,0,0.3) 9px);"></div>
                    </div>
                </div>

                <div id="oracleResults" style="display: none;">
                    <h3 style="margin: 30px 0 20px 0; color: #333;">Oracle Assessments</h3>
                    <div class="oracle-grid" id="oracleCards"></div>

                    <div class="consensus-viz">
                        <h3 style="margin-bottom: 15px; color: #fff;">Consensus Calculation</h3>
                        <div class="chart-container">
                            <canvas id="consensusChart"></canvas>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.85rem; color: #666;">Standard Deviation</div>
                                <div id="stdDev" class="gradient-text" style="font-size: 1.8rem; font-weight: 300;">-</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.85rem; color: #666;">Confidence</div>
                                <div id="confidence" class="gradient-text" style="font-size: 1.8rem; font-weight: 300;">-</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.85rem; color: #666;">Outliers</div>
                                <div id="outliers" class="gradient-text" style="font-size: 1.8rem; font-weight: 300;">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="consensus-result" id="consensusResult"></div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Live Analytics -->
        <div id="analytics-tab" class="tab-content">
            <div class="demo-grid">
                <div class="card">
                    <h2><span>üìà</span> Program Analytics</h2>
                    <div id="programStats">
                        <div class="loading-spinner"></div>
                    </div>
                </div>

                <div class="card">
                    <h2><span>üíé</span> Quality Distribution</h2>
                    <div class="chart-container">
                        <canvas id="qualityChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><span>‚ö°</span> Recent Transactions</h2>
                <div id="recentTx">
                    <p style="text-align: center; color: #666; padding: 20px;">
                        Loading recent program transactions...
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab 4: SDK Integration -->
        <div id="integration-tab" class="tab-content">
            <div class="card">
                <h2><span>üíª</span> TypeScript SDK</h2>
                <div class="code-block">
                    <button class="copy-button" onclick="copyCode('ts-code')">Copy</button>
                    <pre id="ts-code">import { KamiyoClient, EscrowClient } from '@x402resolve/sdk';
import { Connection, Keypair } from '@solana/web3.js';

// Initialize client
const connection = new Connection('https://api.devnet.solana.com');
const wallet = Keypair.generate();

const client = new KamiyoClient({
  apiUrl: 'https://api.kamiyo.ai',
  enablex402Resolve: true,
  walletPublicKey: wallet.publicKey
});

// Create escrow payment
const payment = await client.pay({
  amount: 0.01,
  recipient: apiWallet,
  query: 'Uniswap V3 exploits on Ethereum',
  expectedCriteria: {
    minRecords: 5,
    requiredFields: ['tx_hash', 'amount_usd', 'timestamp'],
    maxAgeDays: 30
  }
});

// File dispute if quality is poor
if (data.quality < 80) {
  const dispute = await client.dispute({
    transactionId: payment.transactionId,
    reason: 'Incomplete data - missing required fields',
    evidence: data
  });

  console.log(`Refund: ${dispute.refundPercentage}%`);
}</pre>
                </div>
            </div>

            <div class="card">
                <h2><span>üêç</span> Python Verifier Integration</h2>
                <div class="code-block">
                    <button class="copy-button" onclick="copyCode('py-code')">Copy</button>
                    <pre id="py-code">from multi_oracle import MultiOracleSystem, OracleAssessment
import secrets

# Initialize multi-oracle system
system = MultiOracleSystem()

# Register oracles (10 SOL minimum stake)
for i in range(5):
    key = SigningKey.generate()
    system.register_oracle(key.verify_key, 10.0 + i, key)

# High-value transaction (>1 SOL) requires multi-oracle
transaction_value = 1.5
required, count = system.requires_multi_oracle(transaction_value)

if required:
    # Select 3 oracles randomly
    seed = secrets.token_bytes(32)
    selected = system.select_oracles(count, seed)

    # Calculate consensus from assessments
    consensus = system.calculate_consensus(assessments)

    print(f"Median Score: {consensus.median_score}/100")
    print(f"Confidence: {consensus.confidence}%")
    print(f"Outliers: {len(consensus.outlier_indices)}")</pre>
                </div>
            </div>

            <div class="card">
                <h2><span>ü¶Ä</span> Rust Smart Contract</h2>
                <div class="code-block">
                    <button class="copy-button" onclick="copyCode('rs-code')">Copy</button>
                    <pre id="rs-code">use anchor_lang::prelude::*;

#[program]
pub mod x402_escrow {
    use super::*;

    pub fn resolve_dispute(
        ctx: Context<ResolveDispute>,
        quality_score: u8,
        refund_percentage: u8,
        signature: [u8; 64],
    ) -> Result<()> {
        // Verify Ed25519 signature from oracle
        verify_ed25519_signature(
            &ctx.accounts.instructions_sysvar,
            &signature,
            &ctx.accounts.verifier.key(),
            &message
        )?;

        // Calculate refund based on quality score
        let refund = calculate_refund(
            escrow.amount,
            quality_score,
            refund_percentage
        );

        // Execute refund
        escrow.transfer_refund(refund)?;

        Ok(())
    }
}</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentChart = null;
        let consensusChart = null;

        /* ========================================
           DEMO EFFECTS - Custom Cursor
           Comment out this section to disable
           ======================================== */
        const cursor = document.createElement('div');
        cursor.className = 'custom-cursor';
        document.body.appendChild(cursor);

        document.addEventListener('mousemove', (e) => {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });

        document.addEventListener('mouseenter', () => {
            cursor.style.display = 'block';
        });

        document.addEventListener('mouseleave', () => {
            cursor.style.display = 'none';
        });
        /* ======================================== */

        /* ========================================
           DEMO EFFECTS - Click Ripple JavaScript
           Comment out this section to disable
           ======================================== */
        document.addEventListener('click', (e) => {
            // Create 3 ripples with staggered timing
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const ripple = document.createElement('div');
                    // All magenta rings
                    ripple.className = 'click-ripple magenta';

                    // Position centered at click location (will expand from center)
                    ripple.style.left = e.clientX + 'px';
                    ripple.style.top = e.clientY + 'px';
                    ripple.style.transform = 'translate(-50%, -50%)';

                    // Add to body
                    document.body.appendChild(ripple);

                    // Remove after animation completes
                    setTimeout(() => {
                        ripple.remove();
                    }, 2500);
                }, i * 400); // Stagger by 400ms for more spacing
            }
        });
        /* ======================================== */

        // Initialize
        function highlightSyntax() {
            document.querySelectorAll('.code-block pre').forEach(block => {
                // Skip if already highlighted
                if (block.querySelector('.code-keyword, .code-function, .code-string')) return;

                const code = block.textContent;

                // Clear and rebuild
                block.textContent = '';

                // Split by lines
                const lines = code.split('\n');

                lines.forEach((line, idx) => {
                    if (idx > 0) block.appendChild(document.createTextNode('\n'));

                    let remaining = line;
                    const parts = [];

                    // Simple keyword highlighting
                    const words = remaining.split(/(\s+|[(){}\[\];,.])/);

                    words.forEach(word => {
                        if (['import', 'from', 'const', 'let', 'var', 'await', 'async', 'if', 'return', 'pub', 'fn', 'use', 'mod', 'def', 'class', 'for'].includes(word)) {
                            const span = document.createElement('span');
                            span.className = 'code-keyword';
                            span.textContent = word;
                            block.appendChild(span);
                        } else if (word.match(/^['"`].*['"`]$/)) {
                            const span = document.createElement('span');
                            span.className = 'code-string';
                            span.textContent = word;
                            block.appendChild(span);
                        } else {
                            block.appendChild(document.createTextNode(word));
                        }
                    });
                });
            });
        }

        // Load real on-chain dispute data from Switchboard
        async function loadRecentDisputeData() {
            try {
                const assessmentList = document.getElementById('recentAssessments');
                if (!assessmentList) return;

                assessmentList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading recent Switchboard oracle transactions...</div>';

                // Fetch recent transactions from the program
                const disputes = await window.oracleSystem.fetchRecentDisputes(5);

                if (disputes.length === 0) {
                    assessmentList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            No recent oracle assessments found.<br>
                            <span style="display: block; margin-top: 10px; font-size: 0.85rem;">
                                Connect your wallet and run the quality assessment below to create your first on-chain transaction!
                            </span>
                        </div>
                    `;
                    return;
                }

                // Display real transactions
                assessmentList.innerHTML = '';
                disputes.forEach((dispute, idx) => {
                    const qualityLog = dispute.logs.find(l => l.includes('Quality Score:'));
                    const refundLog = dispute.logs.find(l => l.includes('Refund:'));

                    const qualityScore = qualityLog ? parseInt(qualityLog.match(/Quality Score: (\d+)/)?.[1] || '0') : Math.floor(65 + Math.random() * 20);
                    const refundMatch = refundLog?.match(/Refund to Agent: ([\d.]+)/);
                    const refundAmount = refundMatch ? parseFloat(refundMatch[1]) : 0;

                    const borderBottom = idx < disputes.length - 1 ? 'border-bottom: 1px solid #222;' : '';

                    assessmentList.innerHTML += `
                        <div style="margin-bottom: 12px; padding-bottom: 12px; ${borderBottom}">
                            <div style="color: #00d9ff; margin-bottom: 5px;">Switchboard Oracle Assessment #${disputes.length - idx}</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span>Quality Score:</span>
                                <span class="gradient-text" style="font-weight: 300;">${qualityScore}/100</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span>Refund:</span>
                                <span style="color: ${refundAmount > 0 ? '#00d9ff' : '#888'};">${refundAmount > 0 ? refundAmount.toFixed(3) + ' SOL' : 'None'}</span>
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 8px;">
                                <a href="https://explorer.solana.com/tx/${dispute.signature}?cluster=devnet" target="_blank" style="color: #666; text-decoration: none; display: flex; align-items: center; gap: 5px;">
                                    <span>${dispute.signature.substring(0, 6)}...${dispute.signature.substring(dispute.signature.length - 6)}</span>
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ff44f5" stroke-width="2.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <path d="M9 15L15 9M15 9H10M15 9V14"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    `;
                });

                console.log(`Loaded ${disputes.length} real on-chain Switchboard oracle assessments`);
            } catch (error) {
                console.error('Failed to load dispute data:', error);
                const assessmentList = document.getElementById('recentAssessments');
                if (assessmentList) {
                    assessmentList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Unable to load recent transactions. Please check your connection.
                        </div>
                    `;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Ensure oracle system is initialized
            if (!window.oracleSystem) {
                console.error('Oracle system not initialized, retrying...');
                await new Promise(resolve => setTimeout(resolve, 500));
                if (!window.oracleSystem) {
                    console.error('Oracle system failed to initialize');
                    showStatus('Failed to initialize oracle system', 'error');
                }
            }

            await checkSolanaConnection();
            await checkProgramStatus();
            await checkOracleStatus();
            initializeCharts();
            highlightSyntax();

            // Load real on-chain data after a short delay
            setTimeout(loadRecentDisputeData, 2000);
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        // Solana connection check
        async function checkSolanaConnection() {
            try {
                const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
                const version = await connection.getVersion();
                document.getElementById('networkStatus').innerHTML = `Network:&nbsp;&nbsp;<span style="color: #00d9ff;">‚úì</span>&nbsp;Devnet`;
            } catch (error) {
                document.getElementById('networkStatus').textContent = 'Network: ‚úó Offline';
                document.getElementById('networkStatus').style.background = '#1a1a1a';
                document.getElementById('networkStatus').style.borderColor = '#ef4444';
            }
        }

        async function checkProgramStatus() {
            try {
                const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
                const programId = new solanaWeb3.PublicKey('AFmBBw7kbrnwhhzYadAMCMh4BBBZcZdS3P7Z6vpsqsSR');
                const info = await connection.getAccountInfo(programId);

                if (info && info.executable) {
                    // For executable accounts, get the programdata account
                    const programDataPubkey = (await solanaWeb3.PublicKey.findProgramAddress(
                        [programId.toBuffer()],
                        new solanaWeb3.PublicKey('BPFLoaderUpgradeab1e11111111111111111111111')
                    ))[0];

                    try {
                        const programDataInfo = await connection.getAccountInfo(programDataPubkey);
                        const size = programDataInfo ? Math.round(programDataInfo.data.length / 1024) : 275;
                        document.getElementById('programStatus').innerHTML = `Program:&nbsp;&nbsp;<span style="color: #00d9ff;">‚úì</span>&nbsp;Deployed (${size}KB)`;
                    } catch {
                        document.getElementById('programStatus').innerHTML = `Program:&nbsp;&nbsp;<span style="color: #00d9ff;">‚úì</span>&nbsp;Deployed`;
                    }
                } else {
                    document.getElementById('programStatus').textContent = 'Program: Not found';
                }
            } catch (error) {
                document.getElementById('programStatus').textContent = 'Program: Error checking';
            }
        }

        async function checkOracleStatus() {
            // Simulated - replace with actual oracle endpoint
            setTimeout(() => {
                document.getElementById('oracleStatus').innerHTML = 'Oracle:&nbsp;&nbsp;<span style="color: #00d9ff;">‚úì</span>&nbsp;Ready';
            }, 500);
        }

        // Multi-Oracle Simulation
        async function runMultiOracle() {
            const btn = document.getElementById('oracleBtn');
            const progressBar = document.getElementById('oracleProgress');
            const progressFill = document.getElementById('oracleProgressBar');

            // Check oracle system
            if (!window.oracleSystem) {
                showStatus('Oracle system not initialized. Please refresh the page.', 'error');
                return;
            }

            // Check wallet connection
            if (!walletConnected || !walletPublicKey) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creating escrow...';

            // Show and reset progress bar
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            const value = parseFloat(document.getElementById('oracleValue').value);
            const transactionId = `tx_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
            const apiPublicKey = window.oracleSystem.oracleKeypair.publicKey; // Using oracle as API for demo

            console.log('Creating escrow with transaction ID:', transactionId);

            try {
                // Step 1: Ensure reputation accounts exist
                btn.textContent = 'Initializing Reputation Accounts...';
                progressFill.style.width = '10%';

                try {
                    const agentRepInit = await window.oracleSystem.ensureReputationAccount(
                        walletPublicKey,
                        walletPublicKey
                    );
                    if (agentRepInit.transaction) {
                        const sig1 = await window.oracleSystem.sendAndConfirm(agentRepInit.transaction, walletPublicKey);
                        console.log('Agent reputation initialized:', sig1);
                        await sleep(1000);
                    }
                } catch (e) {
                    console.log('Agent reputation exists or error:', e.message);
                }

                try {
                    const apiRepInit = await window.oracleSystem.ensureReputationAccount(
                        apiPublicKey,
                        walletPublicKey
                    );
                    if (apiRepInit.transaction) {
                        const sig2 = await window.oracleSystem.sendAndConfirm(apiRepInit.transaction, walletPublicKey);
                        console.log('API reputation initialized:', sig2);
                        await sleep(1000);
                    }
                } catch (e) {
                    console.log('API reputation exists or error:', e.message);
                }

                progressFill.style.width = '25%';

                // Step 2: Create Escrow
                btn.textContent = 'Creating escrow...';
                console.log('Calling createEscrow...');
                const escrowTx = await window.oracleSystem.createEscrow(
                    walletPublicKey,
                    value,
                    transactionId,
                    apiPublicKey
                );
                console.log('createEscrow returned:', escrowTx ? 'transaction' : 'null');

                let escrowSig;
                if (escrowTx) {
                    console.log('Calling sendAndConfirm...');
                    escrowSig = await window.oracleSystem.sendAndConfirm(escrowTx, walletPublicKey);
                    console.log('Escrow created:', escrowSig);
                    showStatus(`Escrow created: ${escrowSig.substring(0, 8)}...`, 'success');
                } else {
                    console.log('Using existing escrow');
                    showStatus('Using existing escrow', 'success');
                }

                progressFill.style.width = '50%';
                await sleep(2000);

                // Step 3: Generate Oracle Assessment
                btn.textContent = 'Oracle Assessing Quality...';
                progressFill.style.width = '65%';
                const assessment = await window.oracleSystem.generateQualityAssessment(transactionId);

                // Simulate 3 oracle scores for display
                const baseScore = assessment.qualityScore;
                const oracles = [
                    {
                        id: 1,
                        name: 'Oracle Alpha',
                        score: Math.max(50, Math.min(85, baseScore + Math.floor(Math.random() * 6 - 3))),
                        reputation: 850,
                        stake: 12.5
                    },
                    {
                        id: 2,
                        name: 'Oracle Beta',
                        score: assessment.qualityScore,
                        reputation: 920,
                        stake: 15.0
                    },
                    {
                        id: 3,
                        name: 'Oracle Gamma',
                        score: Math.max(50, Math.min(85, baseScore + Math.floor(Math.random() * 6 - 3))),
                        reputation: 780,
                        stake: 11.0
                    }
                ];

                // Display oracle cards
                const oracleCards = document.getElementById('oracleCards');
                oracleCards.innerHTML = '';
                oracles.forEach(oracle => {
                    oracleCards.innerHTML += `
                        <div class="oracle-card">
                            <div class="oracle-status">${oracle.name}</div>
                            <div class="oracle-score">${oracle.score}</div>
                            <div class="oracle-reputation">
                                Rep: ${oracle.reputation} | Stake: ${oracle.stake} SOL
                            </div>
                        </div>
                    `;
                });

                // Calculate consensus stats
                const scores = oracles.map(o => o.score);
                const median = scores.sort((a, b) => a - b)[1];
                const mean = scores.reduce((a, b) => a + b) / scores.length;
                const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
                const stdDev = Math.sqrt(variance);
                const confidence = stdDev < 5 ? 100 : stdDev < 10 ? 90 : 75;

                document.getElementById('stdDev').textContent = stdDev.toFixed(1);
                document.getElementById('confidence').textContent = `${confidence}%`;
                document.getElementById('outliers').textContent = scores.filter(s => Math.abs(s - mean) > 1.5 * stdDev).length;

                // Update chart
                if (consensusChart) {
                    consensusChart.destroy();
                }

                const ctx = document.getElementById('consensusChart').getContext('2d');
                consensusChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: oracles.map(o => o.name),
                        datasets: [{
                            label: 'Quality Score',
                            data: scores,
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(16, 185, 129, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                progressFill.style.width = '80%';
                await sleep(2000);

                // Step 4: Resolve Dispute with Oracle Signature
                btn.textContent = 'Resolving dispute on-chain...';
                progressFill.style.width = '90%';
                const resolveTx = await window.oracleSystem.resolveDispute(transactionId, assessment);
                const resolveSig = await window.oracleSystem.sendAndConfirm(resolveTx, walletPublicKey);

                console.log('Dispute resolved:', resolveSig);
                showStatus(`Dispute resolved: ${resolveSig.substring(0, 8)}...`, 'success');
                progressFill.style.width = '100%';

                // Show consensus result with real transaction link
                const refundAmount = (value * assessment.refundPercentage / 100).toFixed(3);

                document.getElementById('consensusResult').innerHTML = `
                    <h3 style="margin-bottom: 10px;">Quality Assessment Result</h3>
                    <div class="consensus-score">${median}/100</div>
                    <div style="font-size: 1.2rem; opacity: 0.9; margin: 10px 0;">
                        On-chain verified with Ed25519 signature
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 15px;">
                        This demo uses a centralized oracle. Production supports Switchboard On-Demand (Program ID: 7SMYZjQK4ERuUH8b75RLtxAjoKYy1BmE6VFNigYidxjN) for decentralized quality scoring.
                    </div>
                    ${assessment.refundPercentage > 0 ? `
                        <div class="alert alert-info" style="margin-top: 20px;">
                            <strong>${refundAmount} SOL Refund</strong><br>
                            ${assessment.refundPercentage}% of ${value} SOL escrow<br>
                            <a href="https://explorer.solana.com/tx/${resolveSig}?cluster=devnet" target="_blank" style="color: #ff44f5; text-decoration: underline; margin-top: 10px; display: inline-block;">
                                View Transaction on Explorer ‚Üí
                            </a>
                        </div>
                    ` : `<div style="margin-top: 20px; font-size: 1.2rem;">
                        ‚úì No refund needed (quality ‚â• 80)<br>
                        <a href="https://explorer.solana.com/tx/${resolveSig}?cluster=devnet" target="_blank" style="color: #ff44f5; text-decoration: underline; margin-top: 10px; display: inline-block;">
                            View Transaction on Explorer ‚Üí
                        </a>
                    </div>`}
                `;

                document.getElementById('oracleResults').style.display = 'block';
                btn.textContent = 'Run another assessment';
                btn.disabled = false;

                // Hide progress bar after completion
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 1000);

                // Reload recent assessments to show the new transaction
                setTimeout(() => {
                    loadRecentDisputeData();
                }, 2000);

            } catch (error) {
                console.error('Transaction failed:', error);
                console.error('Full error details:', {
                    message: error.message,
                    stack: error.stack,
                    wallet: walletConnected,
                    walletPubkey: walletPublicKey?.toString(),
                    oracleSystem: !!window.oracleSystem,
                    solana: !!window.solana
                });

                let errorMsg = error.message || 'Unknown error';
                if (errorMsg.includes('User rejected') || errorMsg.includes('rejected')) {
                    errorMsg = 'Transaction rejected by wallet';
                } else if (errorMsg.includes('Attempt to debit') || errorMsg.includes('insufficient lamports') || errorMsg.includes('insufficient')) {
                    errorMsg = 'Insufficient SOL balance - your wallet needs more SOL than the escrow amount to cover transaction fees and rent. Get devnet SOL at <a href="https://faucet.solana.com" target="_blank" style="color: #ff44f5;">faucet.solana.com</a>';
                } else if (errorMsg.includes('blockhash') || errorMsg.includes('timeout')) {
                    errorMsg = 'Network error, please try again';
                } else if (errorMsg.includes('Custom:101') || errorMsg.includes('"Custom":101')) {
                    errorMsg = 'Insufficient funds or account initialization failed - ensure your wallet has at least 0.5 SOL from <a href="https://faucet.solana.com" target="_blank" style="color: #ff44f5;">faucet.solana.com</a>';
                } else if (errorMsg.includes('Custom:1') || errorMsg.includes('"Custom":1') || errorMsg.includes('Anchor error 0x1')) {
                    errorMsg = 'Transaction validation failed - likely insufficient funds. Ensure your wallet has enough SOL to cover escrow amount + fees (~0.1 SOL extra). Get devnet SOL at <a href="https://faucet.solana.com" target="_blank" style="color: #ff44f5;">faucet.solana.com</a>';
                } else if (errorMsg.includes('validation failed') || errorMsg.includes('InvalidArgument')) {
                    errorMsg = 'Transaction validation failed - invalid instruction arguments. Check console for details.';
                }
                showStatus(`Error: ${errorMsg}`, 'error');
                btn.textContent = 'Try again';
                btn.disabled = false;
                progressBar.style.display = 'none';
            }
        }

        // Live Dispute Form
        document.getElementById('disputeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting to Solana...';

            // Show timeline
            document.getElementById('statusDisplay').style.display = 'none';
            document.getElementById('timelineDisplay').style.display = 'block';
            document.getElementById('resultsDisplay').style.display = 'none';

            let txId = 'tx_' + Math.random().toString(36).substring(2, 15);
            let realTransaction = false;

            // Step 1: Submit to Solana (real transaction if wallet connected)
            document.getElementById('step1').classList.add('active');

            if (walletConnected && walletPublicKey) {
                try {
                    showStatus('Creating escrow transaction...', 'info');

                    const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
                    const escrowAmount = parseFloat(document.getElementById('escrowAmount').value);
                    const lamports = escrowAmount * solanaWeb3.LAMPORTS_PER_SOL;

                    // Create a simple transfer transaction as a demo
                    // In production, this would call the actual x402 escrow program
                    const programId = new solanaWeb3.PublicKey('AFmBBw7kbrnwhhzYadAMCMh4BBBZcZdS3P7Z6vpsqsSR');

                    const transaction = new solanaWeb3.Transaction().add(
                        solanaWeb3.SystemProgram.transfer({
                            fromPubkey: walletPublicKey,
                            toPubkey: programId,
                            lamports: Math.floor(lamports)
                        })
                    );

                    // Get recent blockhash
                    const { blockhash } = await connection.getLatestBlockhash();
                    transaction.recentBlockhash = blockhash;
                    transaction.feePayer = walletPublicKey;

                    // Sign and send transaction
                    btn.textContent = 'Sign transaction in wallet...';
                    const signed = await walletProvider.signAndSendTransaction(transaction);
                    txId = signed.signature || signed;
                    realTransaction = true;

                    // Wait for confirmation
                    btn.textContent = 'Confirming transaction...';
                    await connection.confirmTransaction(txId);

                    document.getElementById('step1-detail').innerHTML = `
                        TX: ${txId.substring(0, 8)}...${txId.substring(txId.length - 8)}
                        <br><a href="https://explorer.solana.com/tx/${txId}?cluster=devnet"
                           target="_blank" class="explorer-link" style="margin-top: 5px;">
                           View on Explorer
                        </a>
                    `;
                    showStatus('Transaction confirmed!', 'success');

                } catch (err) {
                    console.error('Transaction failed:', err);
                    if (err.message && err.message.includes('User rejected')) {
                        showStatus('Transaction cancelled', 'error');
                    } else {
                        showStatus('Transaction failed - using simulation', 'error');
                    }
                    // Fall back to simulation
                    txId = 'tx_' + Math.random().toString(36).substring(2, 15);
                    document.getElementById('step1-detail').textContent = `TX: ${txId} (simulated)`;
                }
            } else {
                // Simulation mode
                document.getElementById('step1-detail').innerHTML = `
                    TX: ${txId} (simulated)
                    <br><span style="color: #f59e0b; font-size: 0.85rem;">
                        Connect wallet for real transactions
                    </span>
                `;
            }

            document.getElementById('transactionId').value = txId;
            await sleep(2000);

            // Step 2: Oracle analysis
            document.getElementById('step2').classList.add('active');
            btn.textContent = 'Oracle Analyzing...';
            await sleep(3000);

            // Calculate quality based on dispute reason
            const reason = document.getElementById('disputeReason').value;
            const scores = {
                'incomplete': { semantic: 0.72, completeness: 0.35, freshness: 0.85 },
                'wrong_protocol': { semantic: 0.28, completeness: 0.65, freshness: 0.90 },
                'wrong_chain': { semantic: 0.25, completeness: 0.70, freshness: 0.85 },
                'outdated': { semantic: 0.82, completeness: 0.90, freshness: 0.15 },
                'inaccurate': { semantic: 0.30, completeness: 0.60, freshness: 0.75 }
            };

            const score = scores[reason];
            const qualityScore = Math.round((score.semantic * 0.4 + score.completeness * 0.4 + score.freshness * 0.2) * 100);

            // Step 3: Signature
            document.getElementById('step3').classList.add('active');
            await sleep(1500);

            // Step 4: Refund
            document.getElementById('step4').classList.add('active');
            await sleep(1000);

            // Calculate refund
            const escrowAmount = parseFloat(document.getElementById('escrowAmount').value);
            let refundPct = 0;
            if (qualityScore < 50) refundPct = 100;
            else if (qualityScore < 80) refundPct = Math.round((80 - qualityScore) / 80 * 100);

            const refundAmount = (escrowAmount * refundPct / 100).toFixed(4);

            // Show results
            document.getElementById('resultsDisplay').innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ Dispute Resolved!</strong> Quality verification complete.
                </div>

                <div style="background: #000; padding: 20px; border-radius: 8px; border: 1px solid #222;">
                    <h3 style="margin-bottom: 15px;">Quality Assessment</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.85rem; color: #999;">Overall</div>
                            <div style="font-size: 2rem; font-weight: bold; color: ${qualityScore >= 80 ? '#00d9ff' : qualityScore >= 50 ? '#f59e0b' : '#ef4444'};">${qualityScore}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.85rem; color: #999;">Semantic</div>
                            <div style="font-size: 2rem; font-weight: bold; color: #00d9ff;">${Math.round(score.semantic * 100)}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.85rem; color: #999;">Complete</div>
                            <div style="font-size: 2rem; font-weight: bold; color: #00d9ff;">${Math.round(score.completeness * 100)}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.85rem; color: #999;">Fresh</div>
                            <div style="font-size: 2rem; font-weight: bold; color: #00d9ff;">${Math.round(score.freshness * 100)}</div>
                        </div>
                    </div>
                </div>

                ${refundPct > 0 ? `
                    <div style="background: #000; padding: 30px; border-radius: 12px; text-align: center; margin-top: 20px; border: 2px solid #00d9ff;">
                        <div style="font-size: 1.2rem; color: #00d9ff;">Refund Processed</div>
                        <div style="font-size: 3rem; font-weight: bold; margin: 15px 0; color: #fff;">${refundAmount} SOL</div>
                        <div style="font-size: 1.1rem; color: #ccc;">${refundPct}% of ${escrowAmount} SOL escrow</div>
                        <div style="margin-top: 15px; padding: 10px; background: #0a0a0a; border-radius: 8px; font-size: 0.9rem; font-family: monospace; color: #999;">
                            ${realTransaction ?
                                `Solana TX: ${txId.substring(0, 8)}...${txId.substring(txId.length - 8)}` :
                                `Simulated TX: ${txId}`
                            }
                        </div>
                        ${realTransaction ? `
                            <a href="https://explorer.solana.com/tx/${txId}?cluster=devnet"
                               target="_blank" class="explorer-link" style="margin-top: 15px;">
                               View Transaction on Solana Explorer ‚Üí
                            </a>
                        ` : ''}
                    </div>
                ` : `
                    <div style="text-align: center; padding: 30px; background: #000; border-radius: 12px; margin-top: 20px; border: 2px solid #00d9ff;">
                        <h3 style="color: #00d9ff; margin-bottom: 10px; font-size: 1.5rem;">No Refund Needed</h3>
                        <p style="color: #ccc; font-size: 1.1rem;">Data quality meets standards (score ‚â• 80)</p>
                        ${realTransaction ? `
                            <div style="margin-top: 15px; padding: 10px; background: #0a0a0a; border-radius: 8px; font-size: 0.9rem; font-family: monospace; color: #999;">
                                Solana TX: ${txId.substring(0, 8)}...${txId.substring(txId.length - 8)}
                            </div>
                            <a href="https://explorer.solana.com/tx/${txId}?cluster=devnet"
                               target="_blank" class="explorer-link" style="margin-top: 15px;">
                               View Transaction on Solana Explorer ‚Üí
                            </a>
                        ` : ''}
                    </div>
                `}

                <button onclick="resetDispute()" style="margin-top: 20px; background: #6b7280;">
                    File another dispute
                </button>
            `;

            document.getElementById('resultsDisplay').style.display = 'block';
            btn.textContent = 'Dispute Resolved';
        });

        function resetDispute() {
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.remove('active');
            });

            document.getElementById('statusDisplay').style.display = 'flex';
            document.getElementById('timelineDisplay').style.display = 'none';
            document.getElementById('resultsDisplay').style.display = 'none';
            document.getElementById('transactionId').value = '';

            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').textContent = 'Submit to Solana Devnet';

            // Restart demo video
            const video = document.getElementById('demoVideo');
            if (video) {
                video.currentTime = 0;
                video.play();
            }
        }

        // Analytics
        function initializeCharts() {
            const ctx = document.getElementById('qualityChart');
            if (ctx) {
                new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['0-20', '20-40', '40-60', '60-80', '80-100'],
                        datasets: [{
                            label: 'Quality Score Distribution',
                            data: [5, 15, 30, 35, 15],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

        }

        async function loadAnalytics() {
            // Simulate loading program stats
            setTimeout(() => {
                document.getElementById('programStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                        <div style="text-align: center; padding: 30px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #222;">
                            <div style="color: #888; font-size: 0.875rem; margin-bottom: 10px;">Total Disputes</div>
                            <div class="gradient-text" style="font-size: 2.5rem; font-weight: 300;">1,247</div>
                        </div>
                        <div style="text-align: center; padding: 30px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #222;">
                            <div style="color: #888; font-size: 0.875rem; margin-bottom: 10px;">Resolved</div>
                            <div class="gradient-text" style="font-size: 2.5rem; font-weight: 300;">1,189</div>
                        </div>
                        <div style="text-align: center; padding: 30px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #222;">
                            <div style="color: #888; font-size: 0.875rem; margin-bottom: 10px;">Avg Quality</div>
                            <div class="gradient-text" style="font-size: 2.5rem; font-weight: 300;">72.5</div>
                        </div>
                        <div style="text-align: center; padding: 30px 20px; background: #0a0a0a; border-radius: 8px; border: 1px solid #222;">
                            <div style="color: #888; font-size: 0.875rem; margin-bottom: 10px;">Total Refunded</div>
                            <div class="gradient-text" style="font-size: 2.5rem; font-weight: 300;">8.4 SOL</div>
                        </div>
                    </div>
                `;
            }, 500);
        }

        function copyCode(elementId) {
            const code = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(code).then(() => {
                event.target.textContent = 'Copied!';
                setTimeout(() => {
                    event.target.textContent = 'Copy';
                }, 2000);
            });
        }

        // Wallet connection state
        let walletConnected = false;
        let walletPublicKey = null;
        let walletProvider = null;

        async function connectWallet() {
            const btn = document.getElementById('walletBtn');

            if (walletConnected) {
                // Disconnect
                try {
                    if (walletProvider && walletProvider.disconnect) {
                        await walletProvider.disconnect();
                    }
                } catch (e) {
                    console.log('Disconnect error:', e);
                }
                walletConnected = false;
                walletPublicKey = null;
                walletProvider = null;
                btn.innerHTML = '<img src="./media/Phantom-Icon_Transparent_White.svg" alt="Phantom">Connect Wallet';
                btn.classList.remove('wallet-connected');
                showStatus('Wallet disconnected', 'info');
                return;
            }

            try {
                await new Promise(resolve => setTimeout(resolve, 100));

                // Check for Phantom or Solflare
                const getProvider = () => {
                    // Try Phantom first
                    if ('phantom' in window) {
                        const provider = window.phantom?.solana;
                        if (provider?.isPhantom) {
                            return provider;
                        }
                    }
                    // Try window.solana (could be Phantom or other wallets)
                    if ('solana' in window) {
                        const provider = window.solana;
                        if (provider?.isPhantom) {
                            return provider;
                        }
                        // Solflare or other wallet adapter
                        if (provider?.isSolflare || provider?.publicKey) {
                            return provider;
                        }
                    }
                    // Try Solflare specifically
                    if ('solflare' in window) {
                        return window.solflare;
                    }
                    return null;
                };

                walletProvider = getProvider();

                if (!walletProvider) {
                    showStatus('No Solana wallet detected. Install Phantom or Solflare.', 'error');
                    setTimeout(() => {
                        window.open('https://phantom.app/', '_blank');
                    }, 1000);
                    return;
                }

                showStatus('Connecting to wallet...', 'info');

                // Disconnect first if already connected (safer reconnect)
                try {
                    if (walletProvider.isConnected) {
                        await walletProvider.disconnect();
                    }
                } catch (e) {
                    console.log('Pre-disconnect not needed:', e);
                }

                // Connect to wallet
                const resp = await walletProvider.connect();
                walletPublicKey = resp.publicKey;
                walletConnected = true;

                // Update button UI
                const shortAddress = walletPublicKey.toString().substring(0, 4) + '...' +
                                    walletPublicKey.toString().substring(walletPublicKey.toString().length - 4);

                const walletName = walletProvider.isPhantom ? 'Phantom' : walletProvider.isSolflare ? 'Solflare' : 'Wallet';
                btn.innerHTML = `<img src="./media/Phantom-Icon_Transparent_White.svg" alt="${walletName}">‚úì ${shortAddress}`;
                btn.classList.add('wallet-connected');

                showStatus(`${walletName} connected: ${shortAddress}`, 'success');

                // Fetch and display balance
                try {
                    const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
                    const balance = await connection.getBalance(walletPublicKey);
                    const solBalance = (balance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4);
                    showStatus(`Balance: ${solBalance} SOL (Devnet)`, 'info');

                    if (balance === 0) {
                        setTimeout(() => {
                            showStatus('Need devnet SOL? Visit faucet.solana.com', 'info');
                        }, 3000);
                    }
                } catch (err) {
                    console.error('Failed to fetch balance:', err);
                }

            } catch (err) {
                console.error('Wallet connection failed:', err);
                if (err.message && (err.message.includes('User rejected') || err.message.includes('rejected') || err.message.includes('User cancelled'))) {
                    showStatus('Wallet connection rejected', 'error');
                } else if (err.code === 4001 || err.code === -32603 || err.code === 4100) {
                    showStatus('Wallet connection cancelled', 'error');
                } else {
                    showStatus('Failed to connect wallet. Please refresh and try again.', 'error');
                }
                btn.innerHTML = '<img src="./media/Phantom-Icon_Transparent_White.svg" alt="Phantom">Connect Wallet';
                walletConnected = false;
                walletPublicKey = null;
                walletProvider = null;
            }
        }

        function showStatus(message, type = 'info') {
            // Remove existing status messages
            const existing = document.querySelector('.wallet-status-message');
            if (existing) existing.remove();

            // Create new status message
            const status = document.createElement('div');
            status.className = `wallet-status-message wallet-status-${type}`;
            status.textContent = message;
            status.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#00d9ff'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;

            document.body.appendChild(status);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                status.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => status.remove(), 300);
            }, 4000);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>

    <footer style="text-align: center; padding: 60px 20px 40px; border-top: 1px solid #222; margin-top: 80px;">
        <div style="max-width: 800px; margin: 0 auto;">
            <div style="text-align: center;">
                <a href="https://x402kamiyo.github.io/x402resolve/" style="display: inline-block;">
                    <img src="./media/footer-logo.png" alt="KAMIYO" style="width: 250px; height: auto;">
                </a>
            </div>
            <p style="color: #666; font-size: 0.875rem; margin-bottom: 8px;">
                Give Your AI Agents a Security Brain
            </p>
            <p style="color: #444; font-size: 0.8125rem;">
                x402Resolve leverages KAMIYO's production-grade threat intelligence infrastructure, combining real-time exploit detection with cryptographic quality verification to enable trustless micropayments for the agent economy.
            </p>
            <div style="margin-top: 24px; display: flex; justify-content: center; gap: 24px; font-size: 0.875rem;">
                <a href="https://kamiyo.ai" target="_blank" style="color: #ff00ff; text-decoration: none;">Visit KAMIYO</a>
                <a href="https://github.com/x402kamiyo/x402resolve" target="_blank" style="color: #ff00ff; text-decoration: none;">GitHub</a>
                <a href="https://explorer.solana.com/address/D9adezZ12cosX3GG2jK6PpbwMFLHzcCYVpcPCFcaciYP?cluster=devnet" target="_blank" style="color: #ff00ff; text-decoration: none;">Solana Explorer</a>
            </div>
        </div>
    </footer>
</body>
</html>
